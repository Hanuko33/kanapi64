#!/bin/bash

wget --version
curl --version
gcc --version

echo "PKG_CONFIG: `pkg-config --version`"

NR_CPUS=`cat /proc/cpuinfo | grep processor | wc -l`
echo "NR_CPUS=${NR_CPUS}"

if [ ! -d ${HOME}/src ]
	then
		echo "missing sources dir, recreating"
		mkdir ${HOME}/src
	fi

cd ci-tests
if [ "${CI}" = "true" ]
then
	if [ ! -d ${HOME}/bin ] ; then mkdir ${HOME}/bin ; fi 
	
	ln -svf `pwd`/../cross_compilers/scripts/pkg_kanapi ${HOME}/bin/pkg_kanapi
	ls -l ${HOME}/bin 

	KANAPI_VER=`cat ../kanapi_system/scripts/KANAPI_VER`
	KANAPI_ROOT="${HOME}/kanapi_${KANAPI_VER}"
	mkdir -p ${KANAPI_ROOT}/x86_64/bin
	mkdir -p ${KANAPI_ROOT}/x86_64/packages/libs

	echo "checking CI"
	if [ "${TRAVIS}" = "true" ]
	then
		echo "TRAVIS"
		ln -sv Makefile.travis Makefile
	fi

	if [ "${CODESHIP}" = "TRUE" ]
	then
		echo "CODESHIP"
		ln -sv Makefile.codeship Makefile
	fi
	if [ -x ${HOME}/bin/pkg_kanapi ] 
	then 
		exit 0 
	else
		exit 2
	fi
else
	ln -s Makefile.local Makefile
	ln -svf `pwd`/../cross_compilers/scripts/pkg_kanapi /bin/pkg_kanapi
fi

